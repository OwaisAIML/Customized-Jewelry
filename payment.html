<script>
(function(){
  // Constants
  const UPI_ID = "Aroobakhan660@okicici";
  const PAYEE = "Customised Jewellary";
  const DEFAULT_QR = "images/Gpay Scanner Toyiba.jpg";
  const WHATSAPP_NUMBER = "919103927064";

  // URL parameters reader
  const urlParams = new URLSearchParams(window.location.search);
  const decodeParam = (param) => { try { return decodeURIComponent(param || '') } catch(e){ return param || '' } };

  // Page params
  const productName = decodeParam(urlParams.get('product')) || 'Customised order';
  const productPrice = decodeParam(urlParams.get('price')) || '';
  const quantity = decodeParam(urlParams.get('qty')) || '1';
  const customerName = decodeParam(urlParams.get('custName')) || '';
  const customerPhone = decodeParam(urlParams.get('phone')) || '';
  const shippingName = decodeParam(urlParams.get('shipName')) || '';
  const shippingPhone = decodeParam(urlParams.get('shipPhone')) || '';
  const address1 = decodeParam(urlParams.get('addr1')) || '';
  const address2 = decodeParam(urlParams.get('addr2')) || '';
  const city = decodeParam(urlParams.get('city')) || '';
  const district = decodeParam(urlParams.get('district')) || '';
  const state = decodeParam(urlParams.get('state')) || '';
  const pincode = decodeParam(urlParams.get('pincode')) || '';
  const note = decodeParam(urlParams.get('note')) || '';

  // Amount calculation
  const unitPrice = productPrice ? parseFloat(productPrice) : 0;
  const qty = parseInt(quantity) || 1;
  const totalAmount = Math.floor(unitPrice * qty);

  // DOM
  const prodNameEl = document.getElementById('prodName');
  const prodPriceEl = document.getElementById('prodPrice');
  const copyBtn = document.getElementById('copyBtn');
  const copyLabel = document.getElementById('copyLabel');
  const copyTick = document.getElementById('copyTick');
  const payBtn = document.getElementById('payBtn');
  const waConfirm = document.getElementById('waConfirm');
  const toast = document.getElementById('toast');
  const qrBox = document.getElementById('qrBox');
  const addressBlock = document.getElementById('addressBlock');

  function initializeUI() {
    prodNameEl.textContent = productName;
    if (totalAmount > 0) {
      if (qty > 1) {
        prodPriceEl.innerHTML = `₹${totalAmount}<br><span class="text-sm text-slate-500">(${qty} × ₹${Math.floor(unitPrice)})</span>`;
      } else {
        prodPriceEl.textContent = `₹${totalAmount}`;
      }
    } else if (productPrice) {
      prodPriceEl.textContent = productPrice;
    } else {
      prodPriceEl.textContent = 'Contact for price';
    }
    qrBox.style.backgroundImage = `url('${DEFAULT_QR}')`;
    renderAddressBlock();
    setupWhatsAppLink();
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  function renderAddressBlock() {
    const parts = [];
    const displayName = shippingName || customerName;
    const displayPhone = shippingPhone || customerPhone;
    if (displayName) parts.push(`<div><strong>Ship to:</strong> ${displayName}</div>`);
    if (displayPhone) parts.push(`<div><strong>Phone:</strong> ${displayPhone}</div>`);
    if (address1) parts.push(`<div>${address1}</div>`);
    if (address2) parts.push(`<div>${address2}</div>`);
    const locationParts = [city, district, state, pincode].filter(Boolean);
    if (locationParts.length > 0) parts.push(`<div>${locationParts.join(', ')}</div>`);
    addressBlock.innerHTML = parts.join('') || '<div class="text-slate-500 text-sm">No address provided</div>';
  }

  function setupWhatsAppLink() {
    const parts = [];
    parts.push(`Hi, I placed an order for "${productName}"`);
    if (totalAmount > 0) {
      parts.push(`Amount: ₹${totalAmount}`);
      if (qty > 1) parts.push(`Quantity: ${qty}`);
    }
    const displayName = shippingName || customerName;
    const displayPhone = shippingPhone || customerPhone;
    if (displayName) parts.push(`Name: ${displayName}`);
    if (displayPhone) parts.push(`Phone: ${displayPhone}`);
    const addressParts = [address1, address2, city, district, state, pincode].filter(Boolean);
    if (addressParts.length > 0) parts.push(`Address: ${addressParts.join(', ')}`);
    if (note) parts.push(`Customization: ${note}`);
    parts.push('Transaction screenshot attached');
    const message = parts.join('\n');
    waConfirm.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
  }

  // Copy UPI
  async function copyUPIId() {
    try {
      await navigator.clipboard.writeText(UPI_ID);
      copyLabel.textContent = 'Copied';
      copyTick.classList.remove('hidden');
      showToast('Copied ✓');
      setTimeout(() => {
        copyLabel.textContent = 'Copy UPI ID';
        copyTick.classList.add('hidden');
      }, 1600);
    } catch(e) {
      alert('Copy failed — please select and copy: ' + UPI_ID);
    }
  }

  function showToast(message) {
    toast.textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => { toast.classList.add('hidden'); }, 2000);
  }

  // Detect platform
  function isAndroid() {
    return /Android/i.test(navigator.userAgent);
  }
  function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  // Build UPI params and URL
  function buildUPIUrl() {
    const params = [
      `pa=${encodeURIComponent(UPI_ID)}`,
      `pn=${encodeURIComponent(PAYEE)}`,
      `tn=${encodeURIComponent('Order: ' + productName)}`,
      `cu=INR`
    ];
    if (totalAmount > 0) params.push(`am=${totalAmount}`);
    return `upi://pay?${params.join('&')}`;
  }

  // Initiate payment with platform-aware deep link
  function initiateUPIPayment(e) {
    // Optional: save order to admin before redirect (keeps local copy)
    saveOrderToAdmin();

    const upiUrl = buildUPIUrl();

    try {
      if (isAndroid()) {
        // Use Android intent URI — this strongly prefers Google Pay app (package specified).
        // If Google Pay isn't installed, Android will show an "Open with" chooser or fallback.
        const intentUri = `intent://upi/pay?${new URLSearchParams(upiUrl.split('?')[1]).toString()}#Intent;package=com.google.android.apps.nbu.paisa.user;scheme=upi;end`;
        // Use location change to trigger intent
        window.location.href = intentUri;

        // After attempting to open, if nothing happens show fallback guidance
        setTimeout(() => {
          showToast('If Google Pay did not open, use the QR or Copy UPI ID to pay.');
        }, 1200);
      } else if (isIOS()) {
        // On iOS: try the UPI URL directly. Many UPI apps on iOS register the upi:// scheme.
        // If it fails (no handler) we show fallback guidance (can't reliably detect failure).
        window.location.href = upiUrl;

        setTimeout(() => {
          showToast('If your UPI app did not open, please scan the QR or copy the UPI ID to pay.');
        }, 1200);
      } else {
        // Desktop / unknown: open QR/copy fallback and a small message
        showToast('Open a UPI app on your phone and scan the QR or copy the UPI ID.');
      }
    } catch (err) {
      console.error('Payment redirect failed:', err);
      showToast('Could not open payment app. Use QR or copy UPI ID.');
    }
  }

  // Save order to local admin (simulate)
  function saveOrderToAdmin() {
    const orderData = {
      id: 'ORD' + Date.now(),
      product: productName,
      amount: totalAmount,
      quantity: qty,
      customerName: shippingName || customerName,
      phone: shippingPhone || customerPhone,
      address1: address1,
      address2: address2,
      city: city,
      district: district,
      state: state,
      pincode: pincode,
      customization: note,
      status: 'pending',
      timestamp: new Date().toISOString(),
      upiId: UPI_ID
    };
    try {
      const existingOrders = JSON.parse(localStorage.getItem('jewelleryOrders') || '[]');
      existingOrders.unshift(orderData);
      localStorage.setItem('jewelleryOrders', JSON.stringify(existingOrders));
      console.log('Order saved to admin dashboard:', orderData);
    } catch (error) {
      console.error('Failed to save order:', error);
    }
  }

  // Event listeners
  copyBtn.addEventListener('click', copyUPIId);
  payBtn.addEventListener('click', initiateUPIPayment);

  // Initialize page
  initializeUI();

  // Save order to admin (simulate order creation). In production, save after payment confirmation.
  setTimeout(saveOrderToAdmin, 1000);

})();
</script>
