<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    // ---------- CONFIG ----------
    const UPI_ID = "Aroobakhan660@okicici";
    const PAYEE_NAME = "Customised Jewellery";
    const WHATSAPP_NUMBER = "919876543210"; // (kept for WA button, unchanged)

    // compute amount from query params (same logic as your page)
    const qs = new URLSearchParams(location.search);
    const price = qs.get("price") || "";
    const qty = parseInt(qs.get("qty") || "1") || 1;
    const num = price ? parseFloat(price) : 0;
    const total = qty * num;
    const amountStr = total > 0 ? total.toFixed(2) : "";

    // ---------- helpers ----------
    function buildUpiUrl() {
      const p = new URLSearchParams();
      p.append("pa", UPI_ID);
      p.append("pn", PAYEE_NAME);
      if (amountStr) p.append("am", amountStr);
      p.append("cu", "INR");
      return "upi://pay?" + p.toString();
    }

    function buildAppSchemes() {
      // Query part after upi://pay?
      const q = buildUpiUrl().split("upi://pay?")[1] || "";

      // Try common app-specific schemes first (order increases success chances)
      // These are the common variants used in the wild; add/remove as you test.
      return [
        `tez://upi/pay?${q}`,       // older Google Pay / Tez variants
        `gpay://upi/pay?${q}`,      // alternate Google Pay
        `googlepay://upi/pay?${q}`, // alternate attempt
        `phonepe://pay?${q}`,       // PhonePe
        `paytmmp://pay?${q}`,       // Paytm
        `upi://pay?${q}`            // generic fallback
      ];
    }

    function buildAndroidIntents() {
      const q = buildUpiUrl().split("upi://pay?")[1] || "";
      return [
        // try some packages: Google Pay, PhonePe, Paytm, then generic
        `intent://pay?${q}#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end`,
        `intent://pay?${q}#Intent;scheme=upi;package=com.phonepe.app;end`,
        `intent://pay?${q}#Intent;scheme=upi;package=net.one97.paytm;end`,
        `intent://pay?${q}#Intent;scheme=upi;end`
      ];
    }

    function isIOS() {
      return /iP(hone|od|ad)/i.test(navigator.userAgent || "");
    }

    // ---------- open helpers ----------
    // iOS: open via hidden iframe and watch document visibility
    function openWithIframe(uri, timeout = 1100) {
      return new Promise((resolve) => {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        let finished = false;

        function cleanup(opened) {
          if (finished) return;
          finished = true;
          try { if (iframe.parentNode) iframe.parentNode.removeChild(iframe); } catch (e) {}
          document.removeEventListener('visibilitychange', onVis);
          resolve(opened);
        }

        function onVis() {
          if (document.visibilityState === 'hidden') {
            cleanup(true); // user left page -> likely app opened
          }
        }
        document.addEventListener('visibilitychange', onVis);

        try {
          iframe.src = uri;
        } catch (e) {
          // ignore possible DOM exceptions
        }

        // timeout -> assume not opened
        setTimeout(() => cleanup(false), timeout);
        document.body.appendChild(iframe);
      });
    }

    // Android / desktop: open via window.location and listen for pagehide/visibility
    function openWithLocation(uri, timeout = 1200) {
      return new Promise((resolve) => {
        let resolved = false;
        const start = Date.now();

        function finish(opened) {
          if (resolved) return;
          resolved = true;
          window.removeEventListener('pagehide', onPageHide);
          resolve(opened);
        }
        function onPageHide() { finish(true); }

        window.addEventListener('pagehide', onPageHide);

        try {
          window.location.href = uri;
        } catch (e) {
          // ignore navigation exceptions
          finish(false);
        }

        // fallback check after timeout
        setTimeout(() => {
          if (!document.hidden) finish(false);
          else finish(true);
        }, timeout);
      });
    }

    // ---------- core attempt routine ----------
    async function openUpiApp() {
      const schemes = buildAppSchemes();
      const intents = buildAndroidIntents();

      // If iOS: prefer iframe attempts (safer)
      if (isIOS()) {
        for (const s of schemes) {
          // try each scheme until one opens
          /* eslint-disable no-await-in-loop */
          const opened = await openWithIframe(s, 1000);
          if (opened) return true;
        }
        // final try the canonical upi://pay
        const openedFinal = await openWithIframe(buildUpiUrl(), 1000);
        return openedFinal;
      } else {
        // Android/others: try direct schemes via location then intents
        for (const s of schemes) {
          /* eslint-disable no-await-in-loop */
          const opened = await openWithLocation(s, 900);
          if (opened) return true;
        }
        for (const it of intents) {
          /* eslint-disable no-await-in-loop */
          const opened = await openWithLocation(it, 900);
          if (opened) return true;
        }
        return false;
      }
    }

    // ---------- fallback UI ----------
    function showFallback() {
      const qr = document.getElementById('qrFallback');
      if (qr) qr.style.display = 'flex';
      const raw = document.getElementById('upiRawContainer');
      if (raw) raw.textContent = buildUpiUrl();
    }

    // ---------- attach to UI safely ----------
    const payBtn = document.getElementById('payBtn');
    if (!payBtn) {
      console.warn('payBtn not found — UPI open not attached');
      return;
    }

    payBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      if (!amountStr) { alert('Amount missing. Please select a product.'); return; }

      try {
        const opened = await openUpiApp();
        if (!opened) showFallback();
      } catch (err) {
        console.error('Error opening UPI app', err);
        showFallback();
      }
    });

    // keep WhatsApp button logic intact and separate - won't be triggered by Pay
    const waBtn = document.getElementById('waBtn');
    if (waBtn) {
      waBtn.addEventListener('click', () => {
        const displayAmount = amountStr ? `₹${amountStr}` : "(amount not auto-filled)";
        const msg = `Hello, I have completed a payment for \"${qs.get('product') || 'Customised Order'}\" of ${displayAmount} via UPI ID ${UPI_ID}. I am attaching the payment screenshot.`;
        const waUrl = WHATSAPP_NUMBER && WHATSAPP_NUMBER.trim().length > 6
          ? `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`
          : null;
        if (waUrl) window.open(waUrl, '_blank');
        else alert('WhatsApp not configured on this page.');
      });
    }

  } catch (mainErr) {
    console.error('UPI script failed', mainErr);
  }
});
</script>
