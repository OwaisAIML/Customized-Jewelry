<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    /* --- CONFIG --- */
    const UPI_ID = "Aroobakhan660@okicici";
    const PAYEE_NAME = "Customised Jewellery";

    const qs = new URLSearchParams(location.search);
    const price = qs.get("price") || "";
    const qty = parseInt(qs.get("qty")||"1") || 1;
    const num = price ? parseFloat(price) : 0;
    const total = qty * num;
    const amountStr = total > 0 ? total.toFixed(2) : "";

    /* --- simple helper to build upi:// URL --- */
    function buildUpiUrl() {
      const p = new URLSearchParams();
      p.append("pa", UPI_ID);
      p.append("pn", PAYEE_NAME);
      if (amountStr) p.append("am", amountStr);
      p.append("cu", "INR");
      return "upi://pay?" + p.toString();
    }

    function buildSchemesAndIntents() {
      const q = buildUpiUrl().split("upi://pay?")[1] || "";
      const schemes = [
        `tez://upi/pay?${q}`,
        `gpay://upi/pay?${q}`,
        `phonepe://pay?${q}`,
        `paytmmp://pay?${q}`,
        `upi://pay?${q}`
      ];
      const intents = [
        `intent://pay?${q}#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end`,
        `intent://pay?${q}#Intent;scheme=upi;package=com.phonepe.app;end`,
        `intent://pay?${q}#Intent;scheme=upi;package=net.one97.paytm;end`,
        `intent://pay?${q}#Intent;scheme=upi;end`
      ];
      return { schemes, intents };
    }

    function isIOS() {
      return /iP(hone|od|ad)/i.test(navigator.userAgent || "");
    }

    /* --- open via hidden iframe (iOS strategy) --- */
    function openViaIframe(uri, timeout = 1200) {
      return new Promise((resolve) => {
        let resolved = false;
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        const onVis = () => {
          if (document.visibilityState === 'hidden') {
            resolved = true;
            cleanup(true);
          }
        };

        const cleanup = (opened = false) => {
          if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
          document.removeEventListener('visibilitychange', onVis);
          if (!resolved) {
            resolved = true;
            resolve(opened);
          }
        };

        document.addEventListener('visibilitychange', onVis);
        try {
          iframe.src = uri;
        } catch (e) {
          // ignore
        }
        // fallback timeout: assume not opened
        setTimeout(() => cleanup(false), timeout);
      });
    }

    /* --- open via navigation (Android strategy) --- */
    function openViaLocation(uri, timeout = 1400) {
      return new Promise((resolve) => {
        let resolved = false;
        const start = Date.now();

        function cleanup(opened = false) {
          if (resolved) return;
          resolved = true;
          window.removeEventListener('pagehide', onPageHide);
          resolve(opened);
        }
        function onPageHide() {
          cleanup(true);
        }
        window.addEventListener('pagehide', onPageHide);

        try {
          window.location.href = uri;
        } catch (e) {
          // ignore
          cleanup(false);
        }

        setTimeout(() => {
          // if still visible assume not opened
          if (!document.hidden) cleanup(false);
          else cleanup(true);
        }, timeout);
      });
    }

    /* --- main attempt routine --- */
    async function tryOpenUpiFlow() {
      const { schemes, intents } = buildSchemesAndIntents();
      let didLeave = false;
      const onVis = () => { if (document.visibilityState === 'hidden') didLeave = true; };
      document.addEventListener('visibilitychange', onVis);

      try {
        if (isIOS()) {
          // try app schemes via iframe on iOS
          for (const s of schemes) {
            if (didLeave) return true;
            // eslint-disable-next-line no-await-in-loop
            const opened = await openViaIframe(s, 1100);
            if (opened) return true;
          }
          // final generic upi:// fallback
          if (!didLeave) {
            const opened = await openViaIframe(buildUpiUrl(), 1100);
            if (opened) return true;
          }
        } else {
          // Android / desktop: try schemes via location then intent URIs
          for (const s of schemes) {
            if (didLeave) return true;
            // eslint-disable-next-line no-await-in-loop
            const opened = await openViaLocation(s, 1000);
            if (opened) return true;
          }
          for (const it of intents) {
            if (didLeave) return true;
            // eslint-disable-next-line no-await-in-loop
            const opened = await openViaLocation(it, 1000);
            if (opened) return true;
          }
        }
        return false;
      } finally {
        document.removeEventListener('visibilitychange', onVis);
      }
    }

    /* --- fallback UI reveal --- */
    function showFallbackUI() {
      try {
        const qr = document.getElementById('qrFallback');
        if (qr) qr.style.display = 'flex';
        const rawContainer = document.getElementById('upiRawContainer');
        if (rawContainer) rawContainer.textContent = buildUpiUrl();
      } catch (e) {
        console.error('Fallback UI error', e);
      }
    }

    /* --- attach to pay button (safe guard if element missing) --- */
    const payBtn = document.getElementById('payBtn');
    if (!payBtn) {
      console.warn('payBtn not found â€” UPI script not attached.');
      return;
    }

    payBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      if (!amountStr) {
        alert('Amount missing. Please return to cart and select the product.');
        return;
      }

      try {
        const opened = await tryOpenUpiFlow();
        if (!opened) showFallbackUI();
      } catch (err) {
        console.error('UPI open flow error', err);
        // show fallback so user can still pay
        showFallbackUI();
      }
    });

  } catch (outerErr) {
    console.error('Error initializing UPI script', outerErr);
  }
});
</script>
