<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pay — Customised Jewellary</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html { scroll-behavior: smooth; }
  body { font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,#fff7f8 0%, #fbf3f6 40%); color: #0f172a; }
  .card { background: color-mix(in srgb, white 92%, transparent); backdrop-filter: blur(6px); }
  .chooser-modal, .fallback-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(2,6,23,0.45); z-index:70; }
  .chooser-card, .fallback-card { width:92%; max-width:480px; background:#fff; padding:1.25rem; border-radius:12px; }
  .debug { position: fixed; left: 8px; bottom: 8px; font-size: 12px; color: #111; background: rgba(255,255,255,0.9); padding:6px 10px; border-radius:8px; box-shadow: 0 6px 18px rgba(2,6,23,0.12); max-width:calc(100% - 40px); word-break:break-all; }
  .app-btn { display:flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer; }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
<main class="w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden card ring-1 ring-black/5">
  <header class="p-6 border-b"><div><h1 class="text-xl font-bold">Complete payment</h1></div></header>

  <section class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="flex flex-col items-center">
      <div id="qrBox" class="w-56 h-56 rounded-xl bg-center bg-cover ring-1 shadow-sm" style="background-image:url('images/Gpay Scanner Toyiba.jpg')"></div>
      <a id="downloadQR" class="mt-4 text-xs underline" href="images/Gpay Scanner Toyiba.jpg" download="Toyiba-UPI-QR.png">Download QR</a>

      <div class="mt-4 w-full">
        <button id="copyBtn" class="w-full px-4 py-2 rounded-xl bg-rose-600 text-white font-semibold">Copy UPI ID</button>
      </div>

      <div class="mt-3 text-xs text-slate-600 text-center">
        <div>UPI ID: <strong id="upiDisplay">Aroobakhan660@okicici</strong></div>
      </div>
    </div>

    <div>
      <div class="p-4 rounded-xl border shadow-sm">
        <div class="text-xs text-slate-500">Product</div>
        <div id="prodName" class="font-semibold mt-1 text-lg">—</div>

        <div class="mt-4 text-xs text-slate-500">Amount</div>
        <div id="prodPrice" class="font-mono font-semibold text-2xl mt-1">—</div>

        <div id="addressBlock" class="mt-4 text-sm"></div>

        <div class="mt-4 grid gap-3">
          <button id="payBtn" class="w-full px-4 py-2 rounded-xl bg-rose-600 text-white font-semibold">Pay with UPI app</button>
        </div>
      </div>
    </div>
  </section>
  <footer class="p-4 text-xs text-slate-500 border-t flex items-center justify-between"><div>© <span id="year"></span> Customised Jewellary</div></footer>
</main>

<!-- chooser -->
<div id="appChooser" class="chooser-modal" role="dialog" aria-hidden="true">
  <div class="chooser-card">
    <div class="flex items-center justify-between">
      <div><h3 class="text-lg font-semibold">Open with</h3><p class="text-sm text-slate-500">Choose UPI app</p></div>
      <button id="chooserClose" class="text-sm underline">Close</button>
    </div>

    <div class="mt-4 grid grid-cols-3 gap-3">
      <button class="app-btn" id="btnGPay">Google Pay</button>
      <button class="app-btn" id="btnPhonePe">PhonePe</button>
      <button class="app-btn" id="btnPaytm">Paytm</button>
    </div>

    <div class="mt-3 text-xs text-slate-500">If app fails to open we'll show instructions.</div>
  </div>
</div>

<!-- fallback -->
<div id="fallbackModal" class="fallback-modal" role="dialog" aria-hidden="true">
  <div class="fallback-card">
    <h3 class="text-lg font-semibold">Open UPI app to pay</h3>
    <p class="text-sm">We couldn't open an app. Use the QR or copy the UPI ID and pay from your phone.</p>
    <div class="mt-4 flex justify-end"><button id="fallbackClose" class="px-3 py-2 rounded bg-slate-200">Close</button></div>
  </div>
</div>

<div id="debug" class="debug">debug: ready</div>

<script>
(function () {
  // CONFIG
  const UPI_ID = "Aroobakhan660@okicici";
  const PAYEE = "Customised Jewellary";

  const PACKAGES = { gpay: 'com.google.android.apps.nbu.paisa.user', phonepe:'com.phonepe.app', paytm:'net.one97.paytm' };

  // Many scheme variants to try per app (expanded).
  const IOS_VARIANTS = {
    gpay: [
      (q)=>'gpay://pay?'+q,
      (q)=>'tez://upi/pay?'+q,
      (q)=>'gpay://upi/pay?'+q,
      (q)=>'googlepay://upi/pay?'+q
    ],
    phonepe: [
      (q)=>'phonepe://pay?'+q,
      (q)=>'phonepe://upi/pay?'+q
    ],
    paytm: [
      (q)=>'paytmmp://pay?'+q,
      (q)=>'paytm://pay?'+q,
      (q)=>'paytmmp://wallet?'+q
    ]
  };

  // helpers
  const qs = new URLSearchParams(window.location.search);
  const productName = decodeURIComponent(qs.get('product')||'Customised order');
  const productPrice = qs.get('price') || '';
  const qty = parseInt(qs.get('qty')||'1',10) || 1;
  const unitPrice = parseFloat(productPrice||'0') || 0;
  const total = (unitPrice * qty) || 0;
  const totalStr = total>0 ? total.toFixed(2) : '';

  const elDebug = document.getElementById('debug');
  function log(s){ console.log('[pay]', s); elDebug.textContent = 'debug: ' + s; }

  function buildBaseQuery(amount){
    const p = new URLSearchParams();
    p.set('pa', UPI_ID);
    p.set('pn', PAYEE);
    p.set('tn', 'Order:'+productName);
    p.set('cu','INR');
    if (amount) p.set('am', amount);
    p.set('tr','ORD'+Date.now());
    return p.toString();
  }

  function upiUrl(amount){ return 'upi://pay?'+buildBaseQuery(amount); }

  // multiple Android intent variants builder
  function intentVariant(pkg, path, amount){
    // path: 'pay' or 'upi/pay'
    const base = buildBaseQuery(amount);
    return `intent://${path}?${base}#Intent;scheme=upi;${pkg?('package='+pkg+';'):''}end`;
  }

  // attempt open: navigates and watches visibilitychange
  function attemptOpen(uri, timeout=1600){
    log('attempting → ' + uri);
    return new Promise((resolve)=>{
      let done=false;
      const onVis=()=>{ if(done) return; done=true; cleanup(); resolve(true); };
      function cleanup(){ document.removeEventListener('visibilitychange', onVis); if(timer) clearTimeout(timer); }
      try { window.location.assign(uri); } catch(e){ console.warn(e); }
      document.addEventListener('visibilitychange', onVis, { once:true });
      const timer = setTimeout(()=> { if(done) return; done=true; cleanup(); resolve(false); }, timeout);
    });
  }

  // show/hide chooser
  const chooser = document.getElementById('appChooser');
  const fallback = document.getElementById('fallbackModal');
  const chooserClose = document.getElementById('chooserClose');
  chooserClose.addEventListener('click', ()=>{ chooser.style.display='none'; chooser.setAttribute('aria-hidden','true'); });
  document.getElementById('fallbackClose').addEventListener('click', ()=>{ fallback.style.display='none'; fallback.setAttribute('aria-hidden','true'); });

  // app-not-installed toast (simple)
  function appNotInstalled(name){
    log(name + ' not opened — probably not installed or refused link');
    alert(name + ' could not be opened. Please install it or use the QR/copy UPI ID.');
  }

  // main open logic per-app (aggressive sequence)
  async function openApp(appKey){
    chooser.style.display='none';
    chooser.setAttribute('aria-hidden','true');
    const isAndroid = /Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const amount = totalStr;
    log('openApp: '+appKey+' platform: '+(isAndroid? 'android': isIOS? 'ios':'desktop'));

    // 1) Android aggressive sequence
    if (isAndroid){
      const pkg = PACKAGES[appKey] || null;
      // try package intent (pay) then (upi/pay)
      if (pkg){
        if (await attemptOpen(intentVariant(pkg,'pay',amount))) return;
        if (await attemptOpen(intentVariant(pkg,'upi/pay',amount))) return;
      }
      // generic intent attempts (system chooser)
      if (await attemptOpen(intentVariant(null,'pay',amount))) return;
      if (await attemptOpen(intentVariant(null,'upi/pay',amount))) return;
      // finally upi://
      if (await attemptOpen(upiUrl(amount))) return;
      // nothing worked
      appNotInstalled(appKey==='gpay'?'Google Pay': appKey==='phonepe'?'PhonePe': appKey==='paytm'?'Paytm':'UPI app');
      fallback.style.display='flex';
      fallback.setAttribute('aria-hidden','false');
      return;
    }

    // 2) iOS sequence: try many scheme variants (some apps use different scheme names)
    if (isIOS){
      const variants = IOS_VARIANTS[appKey] || [];
      const base = buildBaseQuery(amount);
      for (let i=0;i<variants.length;i++){
        const uri = typeof variants[i] === 'function' ? variants[i](base) : variants[i];
        if (await attemptOpen(uri)) return;
      }
      // try generic upi
      if (await attemptOpen(upiUrl(amount))) return;
      appNotInstalled(appKey==='gpay'?'Google Pay': appKey==='phonepe'?'PhonePe': appKey==='paytm'?'Paytm':'UPI app');
      fallback.style.display='flex';
      fallback.setAttribute('aria-hidden','false');
      return;
    }

    // Desktop -> show fallback
    fallback.style.display='flex'; fallback.setAttribute('aria-hidden','false');
  }

  // wire UI
  document.getElementById('btnGPay').addEventListener('click', ()=>openApp('gpay'));
  document.getElementById('btnPhonePe').addEventListener('click', ()=>openApp('phonepe'));
  document.getElementById('btnPaytm').addEventListener('click', ()=>openApp('paytm'));
  document.getElementById('payBtn').addEventListener('click', ()=>{
    chooser.style.display='flex'; chooser.setAttribute('aria-hidden','false');
  });

  // copy UPI
  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(UPI_ID); alert('UPI copied'); } catch(e){ prompt('Copy UPI ID',UPI_ID); }
  });

  // initialize display
  document.getElementById('prodName').textContent = productName;
  document.getElementById('prodPrice').textContent = totalStr?('₹'+totalStr):'Contact for price';
  document.getElementById('year').textContent = new Date().getFullYear();

})();
</script>
</body>
</html>
